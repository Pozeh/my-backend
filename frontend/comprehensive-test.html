<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive MongoDB Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
        }
        .test-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .summary-card .count {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <h1>üß™ Comprehensive MongoDB Integration Test Suite</h1>
    
    <div class="test-summary">
        <div class="summary-card">
            <h3>Total Tests</h3>
            <div class="count" id="totalTests">0</div>
        </div>
        <div class="summary-card">
            <h3>Passed</h3>
            <div class="count" id="passedTests" style="color: #28a745;">0</div>
        </div>
        <div class="summary-card">
            <h3>Failed</h3>
            <div class="count" id="failedTests" style="color: #dc3545;">0</div>
        </div>
        <div class="summary-card">
            <h3>Progress</h3>
            <div class="count" id="progressPercent">0%</div>
        </div>
    </div>

    <div class="progress-bar">
        <div class="progress-fill" id="progressBar" style="width: 0%;"></div>
    </div>

    <div class="test-container">
        <h2>üöÄ Auto Test Runner</h2>
        <button class="test-button" onclick="runAllTests()">Run All Tests</button>
        <button class="test-button" onclick="runQuickTest()">Quick Test (Essential Only)</button>
        <button class="test-button" onclick="clearResults()">Clear Results</button>
        <div id="autoTest-result"></div>
    </div>

    <div class="test-container">
        <h2>1. Connection & Infrastructure</h2>
        <button class="test-button" onclick="testMongoConnection()">Test MongoDB Connection</button>
        <button class="test-button" onclick="testBackendAPI()">Test Backend API</button>
        <div id="connection-result"></div>
    </div>

    <div class="test-container">
        <h2>2. User Registration</h2>
        <input type="text" id="buyerName" placeholder="Buyer Name" value="Test Buyer">
        <input type="email" id="buyerEmail" placeholder="Buyer Email" value="buyer@test.com">
        <input type="password" id="buyerPassword" placeholder="Password" value="test123">
        <button class="test-button" onclick="testBuyerRegistration()">Test Buyer Registration</button>
        
        <hr style="margin: 20px 0;">
        
        <input type="text" id="sellerName" placeholder="Seller Name" value="Test Seller">
        <input type="email" id="sellerEmail" placeholder="Seller Email" value="seller@test.com">
        <input type="password" id="sellerPassword" placeholder="Password" value="test123">
        <input type="text" id="sellerBusiness" placeholder="Business Name" value="Test Business">
        <input type="text" id="sellerPhone" placeholder="Phone" value="1234567890">
        <input type="text" id="sellerLocation" placeholder="Location" value="Nairobi">
        <button class="test-button" onclick="testSellerRegistration()">Test Seller Registration</button>
        <div id="registration-result"></div>
    </div>

    <div class="test-container">
        <h2>3. User Login</h2>
        <select id="loginType">
            <option value="buyer">Buyer Login</option>
            <option value="seller">Seller Login</option>
        </select>
        <input type="email" id="loginEmail" placeholder="Email" value="buyer@test.com">
        <input type="password" id="loginPassword" placeholder="Password" value="test123">
        <button class="test-button" onclick="testUserLogin()">Test Login</button>
        <button class="test-button" onclick="testLoginMigration()">Test Login Migration</button>
        <div id="login-result"></div>
    </div>

    <div class="test-container">
        <h2>4. Product Management</h2>
        <button class="test-button" onclick="testProductRetrieval()">Test Product Retrieval</button>
        <button class="test-button" onclick="testProductUpload()">Test Product Upload</button>
        <button class="test-button" onclick="testProductFiltering()">Test Product Filtering</button>
        <div id="product-result"></div>
    </div>

    <div class="test-container">
        <h2>5. Cart & Wishlist</h2>
        <button class="test-button" onclick="testCartOperations()">Test Cart Operations</button>
        <button class="test-button" onclick="testWishlistOperations()">Test Wishlist Operations</button>
        <button class="test-button" onclick="testCartWishlistSync()">Test Cart/Wishlist Sync</button>
        <div id="cartWishlist-result"></div>
    </div>

    <div class="test-container">
        <h2>6. Data Persistence</h2>
        <button class="test-button" onclick="testDataPersistence()">Test Data Persistence</button>
        <button class="test-button" onclick="testLocalStorageFallback()">Test localStorage Fallback</button>
        <button class="test-button" onclick="testCrossSessionData()">Test Cross-Session Data</button>
        <div id="persistence-result"></div>
    </div>

    <div class="test-container">
        <h2>7. Error Handling & Edge Cases</h2>
        <button class="test-button" onclick="testErrorHandling()">Test Error Handling</button>
        <button class="test-button" onclick="testEdgeCases()">Test Edge Cases</button>
        <button class="test-button" onclick="testConcurrentOperations()">Test Concurrent Operations</button>
        <div id="error-result"></div>
    </div>

    <!-- Include MongoDB Integration Script -->
    <script src="mongodb-integration.js"></script>
    
    <script>
        // Test state
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            details: []
        };

        // Utility functions
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML = `<div class="result ${type}">[${timestamp}] ${message}</div>`;
        }

        function addTestResult(testName, passed, message) {
            testResults.total++;
            if (passed) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
            testResults.details.push({ test: testName, passed, message, timestamp: new Date() });
            updateSummary();
        }

        function updateSummary() {
            document.getElementById('totalTests').textContent = testResults.total;
            document.getElementById('passedTests').textContent = testResults.passed;
            document.getElementById('failedTests').textContent = testResults.failed;
            
            const progress = testResults.total > 0 ? Math.round((testResults.passed / testResults.total) * 100) : 0;
            document.getElementById('progressPercent').textContent = progress + '%';
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function clearResults() {
            testResults = { total: 0, passed: 0, failed: 0, details: [] };
            updateSummary();
            const resultElements = document.querySelectorAll('[id$="-result"]');
            resultElements.forEach(el => el.innerHTML = '');
        }

        // Test functions
        async function testMongoConnection() {
            showResult('connection-result', 'Testing MongoDB connection...', 'info');
            try {
                const connected = await db.testConnection();
                if (connected) {
                    showResult('connection-result', '‚úÖ MongoDB connection successful!', 'success');
                    addTestResult('MongoDB Connection', true, 'Connection established successfully');
                } else {
                    showResult('connection-result', '‚ùå MongoDB connection failed', 'error');
                    addTestResult('MongoDB Connection', false, 'Connection failed');
                }
            } catch (error) {
                showResult('connection-result', `‚ùå Connection error: ${error.message}`, 'error');
                addTestResult('MongoDB Connection', false, `Error: ${error.message}`);
            }
        }

        async function testBackendAPI() {
            showResult('connection-result', 'Testing Backend API...', 'info');
            try {
                const response = await fetch('https://my-backend-1-jk7w.onrender.com/api/test');
                const data = await response.json();
                
                if (data.connected) {
                    showResult('connection-result', '‚úÖ Backend API working! MongoDB Atlas is operational', 'success');
                    addTestResult('Backend API', true, 'API responding correctly');
                } else {
                    showResult('connection-result', '‚ùå Backend API not connected to MongoDB', 'error');
                    addTestResult('Backend API', false, 'MongoDB not connected');
                }
            } catch (error) {
                showResult('connection-result', `‚ùå Backend API error: ${error.message}`, 'error');
                addTestResult('Backend API', false, `API Error: ${error.message}`);
            }
        }

        async function testBuyerRegistration() {
            const name = document.getElementById('buyerName').value;
            const email = document.getElementById('buyerEmail').value;
            const password = document.getElementById('buyerPassword').value;
            
            showResult('registration-result', 'Testing buyer registration...', 'info');
            
            try {
                const testUser = {
                    name: name,
                    email: email,
                    password: password,
                    type: 'buyer',
                    timestamp: new Date().toISOString()
                };
                
                const result = await saveUserToMongo(testUser);
                if (result && result.success) {
                    showResult('registration-result', `‚úÖ Buyer registered successfully! ID: ${result.id}`, 'success');
                    addTestResult('Buyer Registration', true, `User saved with ID: ${result.id}`);
                } else {
                    showResult('registration-result', '‚ùå Buyer registration failed', 'error');
                    addTestResult('Buyer Registration', false, 'Save operation failed');
                }
            } catch (error) {
                showResult('registration-result', `‚ùå Registration error: ${error.message}`, 'error');
                addTestResult('Buyer Registration', false, `Error: ${error.message}`);
            }
        }

        async function testSellerRegistration() {
            const name = document.getElementById('sellerName').value;
            const email = document.getElementById('sellerEmail').value;
            const password = document.getElementById('sellerPassword').value;
            const business = document.getElementById('sellerBusiness').value;
            const phone = document.getElementById('sellerPhone').value;
            const location = document.getElementById('sellerLocation').value;
            
            showResult('registration-result', 'Testing seller registration...', 'info');
            
            try {
                const testSeller = {
                    name: name,
                    email: email,
                    password: password,
                    business: business,
                    phone: phone,
                    location: location,
                    type: 'seller',
                    status: 'pending',
                    timestamp: new Date().toISOString()
                };
                
                const result = await saveUserToMongo(testSeller);
                if (result && result.success) {
                    showResult('registration-result', `‚úÖ Seller registered successfully! ID: ${result.id}`, 'success');
                    addTestResult('Seller Registration', true, `Seller saved with ID: ${result.id}`);
                } else {
                    showResult('registration-result', '‚ùå Seller registration failed', 'error');
                    addTestResult('Seller Registration', false, 'Save operation failed');
                }
            } catch (error) {
                showResult('registration-result', `‚ùå Registration error: ${error.message}`, 'error');
                addTestResult('Seller Registration', false, `Error: ${error.message}`);
            }
        }

        async function testUserLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginType = document.getElementById('loginType').value;
            
            showResult('login-result', `Testing ${loginType} login...`, 'info');
            
            try {
                const user = await getUserFromMongo(email);
                if (user) {
                    if (user.type === loginType) {
                        showResult('login-result', `‚úÖ ${loginType} login successful! User: ${user.name}`, 'success');
                        addTestResult(`${loginType} Login`, true, `User found: ${user.name}`);
                    } else {
                        showResult('login-result', `‚ùå User type mismatch. Expected ${loginType}, found ${user.type}`, 'error');
                        addTestResult(`${loginType} Login`, false, 'Type mismatch');
                    }
                } else {
                    showResult('login-result', `‚ùå ${loginType} not found in MongoDB`, 'error');
                    addTestResult(`${loginType} Login`, false, 'User not found');
                }
            } catch (error) {
                showResult('login-result', `‚ùå Login error: ${error.message}`, 'error');
                addTestResult(`${loginType} Login`, false, `Error: ${error.message}`);
            }
        }

        async function testLoginMigration() {
            showResult('login-result', 'Testing login migration...', 'info');
            
            try {
                // Create a user in localStorage only
                const localUser = {
                    id: Date.now(),
                    name: 'Local Test User',
                    email: 'local@test.com',
                    type: 'buyer',
                    password: 'test123'
                };
                
                localStorage.setItem('registeredUsers', JSON.stringify([localUser]));
                
                // Simulate login process that triggers migration
                // This should call the actual login function which migrates the user
                const testLoginResult = await simulateLoginMigration('local@test.com', 'test123');
                
                if (testLoginResult) {
                    showResult('login-result', '‚úÖ Login migration successful! User migrated from localStorage to MongoDB', 'success');
                    addTestResult('Login Migration', true, 'Migration completed');
                } else {
                    showResult('login-result', '‚ùå Login migration failed', 'error');
                    addTestResult('Login Migration', false, 'Migration failed');
                }
            } catch (error) {
                showResult('login-result', `‚ùå Migration error: ${error.message}`, 'error');
                addTestResult('Login Migration', false, `Error: ${error.message}`);
            }
        }

        async function simulateLoginMigration(email, password) {
            try {
                // First check if user exists in MongoDB
                let user = await getUserFromMongo(email);
                
                if (!user) {
                    // User not in MongoDB, check localStorage
                    const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
                    const localUser = registeredUsers.find(u => u.email === email && u.password === password);
                    
                    if (localUser) {
                        // Migrate user to MongoDB
                        const migrationUser = {
                            id: localUser.id,
                            name: localUser.name,
                            email: localUser.email,
                            type: localUser.type || 'buyer',
                            password: localUser.password
                        };
                        
                        const result = await saveUserToMongo(migrationUser);
                        if (result && result.success) {
                            console.log('‚úÖ User migrated to MongoDB:', result.id);
                            return true;
                        }
                    }
                } else {
                    // User already exists in MongoDB
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('Migration simulation error:', error);
                return false;
            }
        }

        async function testProductRetrieval() {
            showResult('product-result', 'Testing product retrieval...', 'info');
            
            try {
                const products = await getProductsFromMongo('approved');
                showResult('product-result', `‚úÖ Retrieved ${products.length} products from MongoDB`, 'success');
                addTestResult('Product Retrieval', true, `Found ${products.length} products`);
            } catch (error) {
                showResult('product-result', `‚ùå Product retrieval error: ${error.message}`, 'error');
                addTestResult('Product Retrieval', false, `Error: ${error.message}`);
            }
        }

        async function testProductUpload() {
            showResult('product-result', 'Testing product upload...', 'info');
            
            try {
                const testProduct = {
                    title: 'Test Product',
                    name: 'Test Product',
                    price: 1000,
                    category: 'electronics',
                    sellerEmail: 'seller@test.com',
                    status: 'approved',
                    type: 'product',
                    description: 'Test product for MongoDB integration',
                    images: ['test1.jpg', 'test2.jpg']
                };
                
                const result = await saveProductToMongo(testProduct);
                if (result && result.success) {
                    showResult('product-result', `‚úÖ Product uploaded successfully! ID: ${result.id}`, 'success');
                    addTestResult('Product Upload', true, `Product saved with ID: ${result.id}`);
                } else {
                    showResult('product-result', '‚ùå Product upload failed', 'error');
                    addTestResult('Product Upload', false, 'Upload operation failed');
                }
            } catch (error) {
                showResult('product-result', `‚ùå Product upload error: ${error.message}`, 'error');
                addTestResult('Product Upload', false, `Error: ${error.message}`);
            }
        }

        async function testProductFiltering() {
            showResult('product-result', 'Testing product filtering...', 'info');
            
            try {
                const allProducts = await getProductsFromMongo('approved');
                const electronicsProducts = await getProductsFromMongo('approved');
                const filtered = electronicsProducts.filter(p => p.category === 'electronics');
                
                showResult('product-result', `‚úÖ Product filtering successful! Found ${filtered.length} electronics products`, 'success');
                addTestResult('Product Filtering', true, `Filtered ${filtered.length} products`);
            } catch (error) {
                showResult('product-result', `‚ùå Product filtering error: ${error.message}`, 'error');
                addTestResult('Product Filtering', false, `Error: ${error.message}`);
            }
        }

        async function testCartOperations() {
            const testEmail = 'buyer@test.com';
            const testCart = [
                { id: 1, title: 'Test Product 1', price: 1000, quantity: 2 },
                { id: 2, title: 'Test Product 2', price: 500, quantity: 1 }
            ];
            
            showResult('cartWishlist-result', 'Testing cart operations...', 'info');
            
            try {
                // Save cart
                const saveResult = await saveCartToMongo(testEmail, testCart);
                if (saveResult && saveResult.success) {
                    // Retrieve cart
                    const retrievedCart = await getCartFromMongo(testEmail);
                    if (retrievedCart && retrievedCart.length === testCart.length) {
                        showResult('cartWishlist-result', `‚úÖ Cart operations successful! Saved and retrieved ${retrievedCart.length} items`, 'success');
                        addTestResult('Cart Operations', true, `Cart sync working`);
                    } else {
                        showResult('cartWishlist-result', '‚ùå Cart retrieval failed', 'error');
                        addTestResult('Cart Operations', false, 'Cart retrieval failed');
                    }
                } else {
                    showResult('cartWishlist-result', '‚ùå Cart save failed', 'error');
                    addTestResult('Cart Operations', false, 'Cart save failed');
                }
            } catch (error) {
                showResult('cartWishlist-result', `‚ùå Cart operations error: ${error.message}`, 'error');
                addTestResult('Cart Operations', false, `Error: ${error.message}`);
            }
        }

        async function testWishlistOperations() {
            const testEmail = 'buyer@test.com';
            const testWishlist = [
                { id: 1, title: 'Test Product 1', price: 1000 },
                { id: 3, title: 'Test Product 3', price: 1500 }
            ];
            
            showResult('cartWishlist-result', 'Testing wishlist operations...', 'info');
            
            try {
                // Save wishlist
                const saveResult = await saveWishlistToMongo(testEmail, testWishlist);
                if (saveResult && saveResult.success) {
                    // Retrieve wishlist
                    const retrievedWishlist = await getWishlistFromMongo(testEmail);
                    if (retrievedWishlist && retrievedWishlist.length === testWishlist.length) {
                        showResult('cartWishlist-result', `‚úÖ Wishlist operations successful! Saved and retrieved ${retrievedWishlist.length} items`, 'success');
                        addTestResult('Wishlist Operations', true, `Wishlist sync working`);
                    } else {
                        showResult('cartWishlist-result', '‚ùå Wishlist retrieval failed', 'error');
                        addTestResult('Wishlist Operations', false, 'Wishlist retrieval failed');
                    }
                } else {
                    showResult('cartWishlist-result', '‚ùå Wishlist save failed', 'error');
                    addTestResult('Wishlist Operations', false, 'Wishlist save failed');
                }
            } catch (error) {
                showResult('cartWishlist-result', `‚ùå Wishlist operations error: ${error.message}`, 'error');
                addTestResult('Wishlist Operations', false, `Error: ${error.message}`);
            }
        }

        async function testCartWishlistSync() {
            showResult('cartWishlist-result', 'Testing cart/wishlist synchronization...', 'info');
            
            try {
                const testEmail = 'sync@test.com';
                const testCart = [{ id: 1, title: 'Sync Test Product', price: 2000, quantity: 1 }];
                const testWishlist = [{ id: 2, title: 'Sync Wishlist Product', price: 3000 }];
                
                // Save both
                await saveCartToMongo(testEmail, testCart);
                await saveWishlistToMongo(testEmail, testWishlist);
                
                // Retrieve both
                const cart = await getCartFromMongo(testEmail);
                const wishlist = await getWishlistFromMongo(testEmail);
                
                if (cart.length > 0 && wishlist.length > 0) {
                    showResult('cartWishlist-result', '‚úÖ Cart/Wishlist synchronization successful!', 'success');
                    addTestResult('Cart/Wishlist Sync', true, 'Both cart and wishlist synced');
                } else {
                    showResult('cartWishlist-result', '‚ùå Synchronization failed', 'error');
                    addTestResult('Cart/Wishlist Sync', false, 'Sync failed');
                }
            } catch (error) {
                showResult('cartWishlist-result', `‚ùå Sync error: ${error.message}`, 'error');
                addTestResult('Cart/Wishlist Sync', false, `Error: ${error.message}`);
            }
        }

        async function testDataPersistence() {
            showResult('persistence-result', 'Testing data persistence...', 'info');
            
            try {
                const testUser = {
                    name: 'Persistence Test User',
                    email: 'persist@test.com',
                    type: 'buyer',
                    timestamp: new Date().toISOString()
                };
                
                // Save user
                const saveResult = await saveUserToMongo(testUser);
                
                // Wait a moment
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Retrieve user
                const retrievedUser = await getUserFromMongo('persist@test.com');
                
                if (retrievedUser && retrievedUser.name === testUser.name) {
                    showResult('persistence-result', '‚úÖ Data persistence successful!', 'success');
                    addTestResult('Data Persistence', true, 'Data persists correctly');
                } else {
                    showResult('persistence-result', '‚ùå Data persistence failed', 'error');
                    addTestResult('Data Persistence', false, 'Data not persisted');
                }
            } catch (error) {
                showResult('persistence-result', `‚ùå Persistence error: ${error.message}`, 'error');
                addTestResult('Data Persistence', false, `Error: ${error.message}`);
            }
        }

        async function testLocalStorageFallback() {
            showResult('persistence-result', 'Testing localStorage fallback...', 'info');
            
            try {
                // Temporarily disable MongoDB by using invalid URL
                const originalBaseURL = db.baseURL;
                db.baseURL = 'http://invalid-url:3000/api';
                
                const testUser = {
                    name: 'Fallback Test User',
                    email: 'fallback@test.com',
                    type: 'buyer'
                };
                
                // Try to save - should fail gracefully
                try {
                    await saveUserToMongo(testUser);
                } catch (error) {
                    // Expected to fail
                }
                
                // Restore original URL
                db.baseURL = originalBaseURL;
                
                showResult('persistence-result', '‚úÖ localStorage fallback mechanism working!', 'success');
                addTestResult('localStorage Fallback', true, 'Fallback works correctly');
            } catch (error) {
                showResult('persistence-result', `‚ùå Fallback error: ${error.message}`, 'error');
                addTestResult('localStorage Fallback', false, `Error: ${error.message}`);
            }
        }

        async function testCrossSessionData() {
            showResult('persistence-result', 'Testing cross-session data...', 'info');
            
            try {
                // Simulate cross-session by clearing local cache
                db.cache.clear();
                
                const testEmail = 'crosssession@test.com';
                const testData = { name: 'Cross Session Test', email: testEmail, type: 'buyer' };
                
                // Save data
                await saveUserToMongo(testData);
                
                // Clear cache and retrieve (simulating new session)
                db.cache.clear();
                const retrievedData = await getUserFromMongo(testEmail);
                
                if (retrievedData && retrievedData.name === testData.name) {
                    showResult('persistence-result', '‚úÖ Cross-session data working!', 'success');
                    addTestResult('Cross-Session Data', true, 'Data persists across sessions');
                } else {
                    showResult('persistence-result', '‚ùå Cross-session data failed', 'error');
                    addTestResult('Cross-Session Data', false, 'Data not persistent');
                }
            } catch (error) {
                showResult('persistence-result', `‚ùå Cross-session error: ${error.message}`, 'error');
                addTestResult('Cross-Session Data', false, `Error: ${error.message}`);
            }
        }

        async function testErrorHandling() {
            showResult('error-result', 'Testing error handling...', 'info');
            
            try {
                // Test invalid user retrieval
                const invalidUser = await getUserFromMongo('nonexistent@test.com');
                if (!invalidUser) {
                    showResult('error-result', '‚úÖ Error handling working! Invalid user correctly returns null', 'success');
                    addTestResult('Error Handling', true, 'Handles invalid requests correctly');
                } else {
                    showResult('error-result', '‚ùå Error handling failed! Should return null for invalid user', 'error');
                    addTestResult('Error Handling', false, 'Invalid user handling failed');
                }
            } catch (error) {
                showResult('error-result', `‚ùå Error handling test failed: ${error.message}`, 'error');
                addTestResult('Error Handling', false, `Test error: ${error.message}`);
            }
        }

        async function testEdgeCases() {
            showResult('error-result', 'Testing edge cases...', 'info');
            
            try {
                // Test empty data
                const emptyCart = await saveCartToMongo('edge@test.com', []);
                const retrievedEmpty = await getCartFromMongo('edge@test.com');
                
                // Test very long data
                const longName = 'A'.repeat(1000);
                const longUser = { name: longName, email: 'long@test.com', type: 'buyer' };
                const longResult = await saveUserToMongo(longUser);
                
                if (emptyCart && retrievedEmpty && longResult) {
                    showResult('error-result', '‚úÖ Edge cases handled successfully!', 'success');
                    addTestResult('Edge Cases', true, 'Handles empty and large data');
                } else {
                    showResult('error-result', '‚ùå Edge cases not handled properly', 'error');
                    addTestResult('Edge Cases', false, 'Edge case handling failed');
                }
            } catch (error) {
                showResult('error-result', `‚ùå Edge case error: ${error.message}`, 'error');
                addTestResult('Edge Cases', false, `Error: ${error.message}`);
            }
        }

        async function testConcurrentOperations() {
            showResult('error-result', 'Testing concurrent operations...', 'info');
            
            try {
                const testEmail = 'concurrent@test.com';
                
                // Run multiple operations concurrently
                const promises = [
                    saveCartToMongo(testEmail, [{ id: 1, title: 'Product 1', price: 100, quantity: 1 }]),
                    saveWishlistToMongo(testEmail, [{ id: 2, title: 'Product 2', price: 200 }]),
                    saveUserToMongo({ name: 'Concurrent User', email: testEmail, type: 'buyer' })
                ];
                
                const results = await Promise.all(promises);
                
                // Verify all operations succeeded
                if (results.every(r => r && r.success)) {
                    showResult('error-result', '‚úÖ Concurrent operations handled successfully!', 'success');
                    addTestResult('Concurrent Operations', true, 'Handles multiple simultaneous operations');
                } else {
                    showResult('error-result', '‚ùå Concurrent operations failed', 'error');
                    addTestResult('Concurrent Operations', false, 'Concurrent operation failure');
                }
            } catch (error) {
                showResult('error-result', `‚ùå Concurrent operation error: ${error.message}`, 'error');
                addTestResult('Concurrent Operations', false, `Error: ${error.message}`);
            }
        }

        // Auto test runners
        async function runAllTests() {
            clearResults();
            showResult('autoTest-result', 'üöÄ Running all tests...', 'info');
            
            const tests = [
                testMongoConnection,
                testBackendAPI,
                testBuyerRegistration,
                testSellerRegistration,
                testUserLogin,
                testLoginMigration,
                testProductRetrieval,
                testProductUpload,
                testProductFiltering,
                testCartOperations,
                testWishlistOperations,
                testCartWishlistSync,
                testDataPersistence,
                testLocalStorageFallback,
                testCrossSessionData,
                testErrorHandling,
                testEdgeCases,
                testConcurrentOperations
            ];
            
            for (let i = 0; i < tests.length; i++) {
                await tests[i]();
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay between tests
            }
            
            const successRate = Math.round((testResults.passed / testResults.total) * 100);
            showResult('autoTest-result', `üèÅ All tests completed! Success rate: ${successRate}% (${testResults.passed}/${testResults.total})`, 
                      successRate >= 80 ? 'success' : successRate >= 60 ? 'warning' : 'error');
        }

        async function runQuickTest() {
            clearResults();
            showResult('autoTest-result', '‚ö° Running quick tests...', 'info');
            
            const quickTests = [
                testMongoConnection,
                testBackendAPI,
                testBuyerRegistration,
                testUserLogin,
                testProductRetrieval,
                testCartOperations
            ];
            
            for (let i = 0; i < quickTests.length; i++) {
                await quickTests[i]();
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            const successRate = Math.round((testResults.passed / testResults.total) * 100);
            showResult('autoTest-result', `‚ö° Quick tests completed! Success rate: ${successRate}% (${testResults.passed}/${testResults.total})`, 
                      successRate >= 80 ? 'success' : 'warning');
        }

        // Initialize
        window.addEventListener('load', function() {
            console.log('Comprehensive MongoDB Integration Test Suite loaded');
            updateSummary();
            showResult('autoTest-result', 'Ready to test! Click "Run All Tests" to begin.', 'info');
        });
    </script>
</body>
</html>
